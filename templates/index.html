<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Chat App</title>
    <style>
  .translated-message {
    display: flex;
    align-items: center;
  }
  .translated-message p {
    margin-right: 10px;
  }
</style>
    <style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f5f5f5;
    padding: 20px;
  }

  h1 {
    color: #2c3e50;
  }

  #message-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  input[type="text"],
  select {
    padding: 6px;
    border-radius: 3px;
    border: 1px solid #ccc;
  }

  button {
    padding: 6px 10px;
    background-color: #2c3e50;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
  }

  button:hover {
    background-color: #1a2533;
  }

  .play-button {
    background-color: #3498db;
  }

  .play-button:hover {
    background-color: #217dbb;
  }

  #messages,
  #translated-messages {
    background-color: white;
    border-radius: 5px;
    padding: 15px;
    margin-top: 20px;
    max-height: 400px;
    overflow-y: scroll;
  }

  #translated-messages .translated-message {
    display: flex;
    align-items: flex-start;
    gap: 5px;
  }

  #messages p,
  #translated-messages p {
    margin: 5px 0;
  }

  #messages strong,
  #translated-messages strong {
    font-weight: bold;
  }
</style>


  </head>
  <body>
    <h1>Chat App</h1>

    <div id="messages"></div>
    <form id="message-form" method="POST" onsubmit="return false;">
      <div>
  <label for="input-language-dropdown">Input language:</label>
  <select id="input-language-dropdown">
    <option value="" disabled selected>Select input language</option>
    <option value="en">English</option>
    <option value="es">Spanish</option>
    <option value="fr">French</option>
    <option value="de">German</option>
  </select>
</div>

  <label for="username">Username:</label>
  <input type="text" id="username" required>
  <button type="button" onclick="startListening()">Record</button>
  <p id="transcript"></p>
      <div>
        <label for="language-dropdown">Translate to:</label>
        <select id="language-dropdown" onchange="translateText()">
          <option value="" disabled selected>Select input language</option>
          <option value="en">English</option>
          <option value="es">Spanish</option>
          <option value="fr">French</option>
          <option value="de">German</option>
        </select>
      </div>
      <p id="translated-text"></p>
      <div id="translated-messages"></div>
    </form>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    const session_id = "{{ session_id }}";
    var messages = [];
      function sendMessage(message) {
  const username = $('#username').val();
  const inputLanguage = $('#input-language-dropdown').val();
  $.ajax({
  url: `/${session_id}/chat`,

    method: 'POST',
    data: { message: message, username: username, input_language: inputLanguage },
    success: function(response) {
      console.log(response);
    },
    error: function(error) {
      console.log(error);
    }
  });
}


function getMessages() {
  $.ajax({
    url: `/${session_id}/get_messages`,
    method: 'GET',
    success: function(response) {
      console.log(response);
      messages = response.messages;
      var messagesDiv = $('#messages');
      messagesDiv.empty();
      for (var i = 0; i < messages.length; i++) {
      var message = messages[i];
      var username = message.message.split(':')[0];
      var messageText = message.message.split(':')[1].trim();

      var usernameStrong = $('<strong>').text(username+":");
      var messageP = $('<p>').append(usernameStrong, messageText);
      messageP.attr('data-input-language', message.input_language); // Add this line
      messagesDiv.append(messageP);
    }

      // Call translateText() after updating the messages

    },
    error: function(error) {
      console.log(error);
    }
  });
}


function refresh_messages() {
  $.get('/<session_id>/get_messages', function(response) {
    console.log(response);
    var messages = response.messages;
    var message_list = $('#message-list');
    message_list.empty();
    for (var i = 0; i < messages.length; i++) {
      message_list.append($('<li>').text(messages[i]));

    }
  });
}

setInterval(refresh_messages, 5000);
setInterval(getMessages, 100);

$(document).ready(function() {
  setInterval(getMessages, 1000);
});

function startListening() {
  const inputLanguage = $('#input-language-dropdown').val();
  const selectedLanguage = $('#language-dropdown').val();

  if (!inputLanguage || !selectedLanguage) {
    alert('Please select both input and translation languages before recording.');
    return;
  }

  const recognition = new webkitSpeechRecognition();
  recognition.lang = inputLanguage;
  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    $('#transcript').text(transcript);
    sendMessage(transcript);
  };
  recognition.start();
}

setInterval(translateText, 2500);

function playMessage(text, language) {
  const msg = new SpeechSynthesisUtterance();
  msg.text = text;
  msg.lang = language;
  window.speechSynthesis.speak(msg);
}

function translateText(language = $('#language-dropdown').val()) {
  //const language = $('#language-dropdown').val();
  const messagesDiv = $('#messages');
  const messages = messagesDiv.find('p');
  $('#translated-messages').empty(); // clear the translated messages with play buttons

  messages.each(function(index) {
    const username = $(this).find('strong').text();
    const originalText = $(this).text().substring(username.length);
    const inputLanguage = messages[index].dataset.inputLanguage || 'en';

    if (inputLanguage === language) {
      // If the source and target languages are the same, just copy the message without translation
      const translatedP = $('<p>').html(originalText);
      const playButton = $('<button>').text('Play').addClass('play-button');
      const usernameStrong = $('<strong>').text(username);
      const translatedMessageDiv = $('<div>').addClass('translated-message').append(usernameStrong, '&nbsp;', translatedP, playButton);
      $('#translated-messages').append(translatedMessageDiv);
    } else {
      const url = `https://translation.googleapis.com/language/translate/v2?key=AIzaSyAySO6GFLG5yZavrDNKl4LEtzrGXyAi9yE&q=${originalText}&source=${inputLanguage}&target=${language}`;
      $.ajax({
        url: url,
        method: 'GET',
        success: function(response) {
          const translatedText = response.data.translations[0].translatedText;
          const translatedP = $('<p>').html(translatedText);
          const playButton = $('<button>').text('Play').addClass('play-button');
          const usernameStrong = $('<strong>').text(username);
          const translatedMessageDiv = $('<div>').addClass('translated-message').append(usernameStrong, '&nbsp;', translatedP, playButton);
          $('#translated-messages').append(translatedMessageDiv);
        },
        error: function(error) {
          console.log(error);
        }
      });
    }
  });
}



$('#translated-messages').on('click', '.play-button', function() {
  const language = $('#language-dropdown').val();
  const translatedText = $(this).closest('.translated-message').find('p').text();
  playMessage(translatedText, language);
});





    </script>
  </body>
</html>
